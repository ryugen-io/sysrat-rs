name: Check Skip File

on:
  workflow_call:
    inputs:
      workflow_name:
        description: "Name of the workflow to check (e.g., 'claude', 'claude-review', 'update-readme')"
        required: false
        type: string
        default: "all"
    outputs:
      should_skip:
        description: "Whether to skip the workflow"
        value: ${{ jobs.validation.outputs.should_skip }}

jobs:
  validation:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check_skip_file.outputs.skip }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for .skip file
        id: check_skip_file
        env:
          SKIP_HASH_ALL: ${{ secrets.SKIP_FILE_HASH_ALL }}
          SKIP_HASH_CLAUDE: ${{ secrets.SKIP_FILE_HASH_CLAUDE }}
          SKIP_HASH_CLAUDE_REVIEW: ${{ secrets.SKIP_FILE_HASH_CLAUDE_REVIEW }}
          SKIP_HASH_UPDATE_README: ${{ secrets.SKIP_FILE_HASH_UPDATE_README }}
          WORKFLOW_NAME: ${{ inputs.workflow_name }}
        run: |
          source .github/workflows/scripts/ci-logger.sh

          log_header "CI/CD Skip Check"

          # Function to get the expected content for a skip file type (default fallback)
          get_expected_content() {
            local file_type="$1"
            case "$file_type" in
              "all")
                echo "SKIP_ALL"
                ;;
              "claude")
                echo "SKIP_CLAUDE"
                ;;
              "claude-review")
                echo "SKIP_REVIEW"
                ;;
              "update-readme")
                echo "SKIP_README"
                ;;
              *)
                echo ""
                ;;
            esac
          }

          # Function to get the expected hash for a skip file type (custom override)
          get_expected_hash() {
            local file_type="$1"
            case "$file_type" in
              "all")
                echo "$SKIP_HASH_ALL"
                ;;
              "claude")
                echo "$SKIP_HASH_CLAUDE"
                ;;
              "claude-review")
                echo "$SKIP_HASH_CLAUDE_REVIEW"
                ;;
              "update-readme")
                echo "$SKIP_HASH_UPDATE_README"
                ;;
              *)
                echo ""
                ;;
            esac
          }

          # Function to validate a skip file
          validate_skip_file() {
            local skip_file="$1"
            local file_type="$2"

            if [ ! -f "$skip_file" ]; then
              return 1
            fi

            log_info "Checking ${file_type} skip file: ${skip_file}"
            local skip_hash=$(sha256sum "$skip_file" | awk '{print $1}')
            local expected_hash=$(get_expected_hash "$file_type")
            local expected_content=$(get_expected_content "$file_type")

            # If custom hash is configured, check hash
            if [ -n "$expected_hash" ]; then
              log_step "verify" "Verifying skip file hash (custom mode)..."
              if [ "$skip_hash" = "$expected_hash" ]; then
                log_success "Skip file verified (custom hash match)"
                log_warn "Workflow '${WORKFLOW_NAME}' will be SKIPPED"
                return 0
              else
                log_error "Skip file hash mismatch!"
                log_warn "Expected: ${expected_hash}"
                log_warn "Got:      ${skip_hash}"
                log_info "Ignoring invalid skip file for security reasons"
                return 1
              fi
            # Otherwise, check default content
            else
              log_step "verify" "Verifying skip file content (default mode)..."
              local skip_content=$(cat "$skip_file" | tr -d '[:space:]')
              if [ "$skip_content" = "$expected_content" ]; then
                log_success "Skip file verified (default content match: '${expected_content}')"
                log_warn "Workflow '${WORKFLOW_NAME}' will be SKIPPED"
                return 0
              else
                log_error "Skip file has invalid content!"
                log_warn "Expected: '${expected_content}'"
                log_warn "Got:      '${skip_content}'"
                log_info "Ignoring invalid skip file for security reasons"
                log_info "See .github/skips/SKIP_SYSTEM.md for setup instructions"
                return 1
              fi
            fi
          }

          # Check for global skip file (.skip.all)
          GLOBAL_SKIP_FILE=".github/skips/.skip.all"

          # Check for workflow-specific skip file (.skip.<workflow_name>)
          WORKFLOW_SKIP_FILE=".github/skips/.skip.${WORKFLOW_NAME}"

          # Validate global skip file first
          if validate_skip_file "$GLOBAL_SKIP_FILE" "all"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            log_info "Workflow log saved to: ${LOG_FILE}"
            exit 0
          fi

          # Validate workflow-specific skip file
          if validate_skip_file "$WORKFLOW_SKIP_FILE" "${WORKFLOW_NAME}"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            log_info "Workflow log saved to: ${LOG_FILE}"
            exit 0
          fi

          # No valid skip file found
          echo "skip=false" >> $GITHUB_OUTPUT
          log_success "No valid skip file found - workflow will proceed"
          log_info "Workflow log saved to: ${LOG_FILE}"

      # Note: Logs are uploaded as artifacts here, but committed by the calling workflow
      - name: Upload skip check logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skip-check-logs
          path: .github/logs/
          retention-days: 30
